# Калькулятор

## Вариант задания: М1 - Рекурсивный спуск
Грамматика:
- expr → add
- add → mul ( (+|-) mul)*
- mul → pow ( (* | / | // | % ) pow)*
- pow → unary (** pow)?
- unary → (+|-) unary | primary
- primary → NUM | ( expr )

Каждое правило реализовано отдельной функцией.

## Цель
Изучить EBNF-нотацию и освоить с помощью неё метод рекурсивного спуска для создания калькулятора. Ознакомиться с методами тестирования, созданием грамотной архитектуры приложения, которую будет устойчивой к ошибкам, а также лекго масштабируемой.

## Использованные системные библиотеки
- sys
- math

## Допустимый алфавит
Допустим следующий список символов:

{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, +, -, *, /, %, .}

## Допустимые операции и правила
Калькулятор поддерживает следующие операции и правила:
- Сложение +
- Вычитание -
- Умножение *
- Деление /
- Возведение в степень **
- Целочисленно деление // (только для целых)
- Получения остатка от деления % (только для целых)
- Унарный плюс и минус
    - Если число записано в начале выражения, то пользователю допустимо записывать унарные - или + без скобок
    - Иначе пользователю необходимо записать число с унарным - или + согласно правила математики: в скобках

- Число с плавающей точкой может записано без целой части, если подразумевается, что целая часть равна нулю (пример: 0.5 -> .5)
- Остальное всё рассчитывается согласно правилам подсчёта Python

## Описание правил ввода арифметического выражения
Арифметическое выражение, введённое пользователем, считается корректным, если оно удовлетворяет следующим правилам:
- В выражении не записаны операторы, идущие друг за другом. Если это унарные операторы - или + и они идут друг за другом, то они должны быть записаны в скобках, согласно правила математики (пример: "-+7" - неверно; "-(+7)" - корректно)
- В выражении не записаны числа, идущие друг за другом без оператора
- В выражении не нарушен баланс скобок
- В выражении нет скобок, которые ничего в себе не содержат
- В выражении нет конфликтных ситуаций, связяных с плавающей точкой числа (пример недопустимых вариантов: "7.28.2"; ".2." и т.д.)

Количество пробелов в выражении ни на что не влияет

## Описание архитектуры приложения
Архитектура разделена на три основных:
- Модуль валидации (validator.py)
- Модуль токенизации (tokenizer.py)
- Модуль подсчёта (calculator.py)

### Валидация
Первым этапом является валидация выражения. Валидация происходит поэтапно:
1. Проверка выражения на отсутствие символов, не указанных в алфавите
2. Проверка на отсутствие ошибочного ввода точек при вводе чисел с плавающей точкой

Дойдя до этого этапа, выражение уже считается корректным для токенизации, следовательно, для более удобного использования выражения, оно токенизируется (правила токенизации будут описаны в модуле токенизации)

3. Проверка баланса скобок. Важно, чтобы количество открывающих и закрывающих скобок было одним и тем же, а расстановка скобок не была нарушена
4. Проверка на отсутствие в выражении пустых скобок "()"
5. Проверка на отсутствие операторов, идущих друг за другом.
6. Проверка на отсутствие чисел, идущих друг за другом

Если была найдена ошибка, модуль вызывает соответствующее исключение, которое обрабатывается программой
Иначе выражение считается корректным, после чего мы можем его отправить на токенизацию.

### Токенизация
Вторым этапом является токенизация уже проверенного выражения. Валидация происходит по следующим правилам:
1. Оператор считается отдельным токеном
2. Число считается отдельным токеном
3. Унарный + или - считаются отдельными токенами

Описания алгоритма токенизации:
1. Пока не достигли конца строки, итерируемся по ней
2. Видя пробелы, пропускаем их
3. Видя оператор, начинаем дополнительно его парсить и заносить в класс-токен Operator
4. Видя точку или цифру, начинаем парсить число, пока не встретим другой символ. Готовое число заносим в класс-токен Number, указывая, целое оно или нет.

### Калькулятор
После того, как выражение было токенизировано, калькулятор приступает к работе.
Рекурсивный спуск работает по следующим правилам:
- Начало обработки выражения expr() -> спускаем на уровень функции add()
- Функция для сложения и вычитания производит подсчёт только в том случае, как у нас будут обработаны более нижнии уровни в силу приоритетов. Переход к mul()
- Функция для умножения, деления, целочисленного деления, получения остатка от деления будет выполняться, пока у нас есть соответственные операторы, а так же, если нижние уровни вернули результат, подсчитам перед этим операцию возведения в степень. Переход к pow()
- Функция для возведения в степень. В силу того, что операция возведения в степень правоассоциативная, то мы применяем её лишь один раз на данном этапе функции.
Переход к unary()
- Применения унарного плюса или минуса к числу, которое было получено со следующего уровня. Переход к primary()
- Возвращение числа. Если встречена открывающая скобка, то всё начинается по новой с функции expr()

На случай возникновения ошибок в моменте вычисления, калькулятор ведёт логирование вычисления:
- деление на ноль
- использование не целых чисел для операций // и %
- запрос на подсчёт слишком больших чисел

#### Дополнительный функционал модуля калькулятора
Модуль способен производитель оценку сверху для вычислений. Если результат является слишком большим для вывода (в целочисленном формате), то программа вызывает исключения. Если возникает проблема при подсчёте числа (в формате числа с плавающей точкой), то программа так же вызывает исключение

## Дополнительные модули

#### Модуль токенов
Родительский класс: Token (хранит значение токена)
- Дочерний класс Operator (хранит оператор)
- Дочерний класс Number (хранит число)

#### Исключения
Родительский класс исключения ExpressionError
- Дочерний класс TokenErrors
    - Дочерний класс BracketsBalanceError
    - Дочерний класс EmptyBracketsError
    - Дочерний класс InvalidBinaryOperatorError
    - Дочерний класс TwiceNumberError
- Дочерний класс ExpressionStringError
    - Дочерний класс UnknownSymbolError
    - Дочерний класс NumberDotError

Отдельное исключение: DigitsOverFlow

## Интересные тесты:
- Число с двумя несколькими точками "7.25.23"
- Оператор без числа в конце выражения "7 + 8 *"
- Выражение только из унарных знаков "--++--"
- Две точки подряд ".."
- Баланс скобок в порядке, но нарушена расстановка ")("

## Инструкция по использованию
Находясь в корне католога
```shell
pytest -q
```
После успешного прохождения всех тестов, запускаем программу
```shell
python -m src.main
```
Для завершения работы программы, напишите символ 'q' в нижнем регистре

## Итоги
- Был изучен большой объём информации, связанный с проектирование рекурсивного спуска
- Освоен навык тестирования с помощью библиотеки ***pytest***
- Был улучшен навык написания более чистого кода
- Освоены навыки декомпозиции функций на более маленький по функционалу блоки
